<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Alerts - SecuAI</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-check"></i> SecuAI
            </a>
            
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a class="nav-link" href="/alerts">
                    <i class="bi bi-exclamation-triangle"></i> Alerts
                </a>
                <a class="nav-link" href="/firewall">
                    <i class="bi bi-shield-lock"></i> Firewall
                </a>
                <a class="nav-link" href="/analysis">
                    <i class="bi bi-search"></i> Analysis
                </a>
            </div>
            
            <div class="navbar-nav">
                {% if current_user.is_authenticated %}
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle"></i> {{ current_user.username }}
                </span>
                <a class="nav-link" href="/admin">
                    <i class="bi bi-gear"></i> Admin
                </a>
                <a class="nav-link" href="/logout">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="bi bi-moon-fill" id="theme-icon"></i>
    </button>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-exclamation-triangle text-warning"></i> Security Alerts
                </h1>
                <p class="text-muted">Monitor and manage security threats detected by SecuAI</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="refreshAlerts()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-range"></i> Date Range Filter
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="start-date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start-date" 
                               value="{{ date_range.start_date_str if date_range else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end-date" 
                               value="{{ date_range.end_date_str if date_range else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="quick-filter" class="form-label">Quick Filters</label>
                        <select class="form-select" id="quick-filter" onchange="applyQuickFilter()">
                            <option value="custom">Custom Range</option>
                            <option value="24h" {% if date_range and date_range.is_default_range %}selected{% endif %}>Last 24 Hours</option>
                            <option value="48h" selected>Last 48 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="filterAlerts()">
                            <i class="bi bi-funnel"></i> Apply Filter
                        </button>
                    </div>
                </div>
                
                <!-- Current Range Info -->
                {% if date_range %}
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        {% if date_range.is_default_range %}
                        Showing alerts from the last 48 hours
                        {% else %}
                        Showing alerts from {{ date_range.start_date.strftime('%B %d, %Y') }} to {{ date_range.end_date.strftime('%B %d, %Y') }}
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Summary Statistics -->
        {% if date_range %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">{{ date_range.total_alerts }}</h3>
                        <p class="text-muted mb-0">Total Alerts</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">{{ date_range.critical_alerts }}</h3>
                        <p class="text-muted mb-0">Critical (≥80%)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">{{ date_range.medium_alerts }}</h3>
                        <p class="text-muted mb-0">Medium (60-79%)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-info">{{ date_range.unique_ips }}</h3>
                        <p class="text-muted mb-0">Unique IPs</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Alerts Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Filter by Confidence:</label>
                        <select class="form-select" id="confidence-filter" onchange="filterAlerts()">
                            <option value="">All Levels</option>
                            <option value="high">High (≥80%)</option>
                            <option value="medium">Medium (60-79%)</option>
                            <option value="low">Low (<60%)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search IP:</label>
                        <input type="text" class="form-control" id="ip-search" placeholder="Enter IP address" onkeyup="filterAlerts()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Alert Type:</label>
                        <select class="form-select" id="type-filter" onchange="filterAlerts()">
                            <option value="">All Types</option>
                            <option value="failed_login">Failed Logins</option>
                            <option value="port_scan">Port Scans</option>
                            <option value="web_probing">Web Probing</option>
                            <option value="ids_alert">IDS Alerts</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Security Alerts</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="alerts-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>IP Address</th>
                                <th>Threat Type</th>
                                <th>AI Analysis</th>
                                <th>Description</th>
                                <th>Confidence</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in alerts %}
                            {% set alert_details = alert.details | safe %}
                            {% if alert_details.startswith('{') %}
                                {% set details_dict = alert_details | replace("'", '"') %}
                                {% set ai_analysis = {} %}
                                {% if 'ai_analysis' in details_dict %}
                                    {% set ai_analysis = alert_details %}
                                {% endif %}
                            {% endif %}
                            
                            <tr data-ip="{{ alert.ip }}" data-confidence="{{ alert.confidence }}" data-type="{{ alert.reason.lower() }}" data-alert-id="{{ alert.id }}">
                                <td>
                                    <small class="text-muted">
                                        {{ alert.created_at.strftime('%m/%d %H:%M') }}
                                    </small>
                                </td>
                                <td>
                                    <code class="bg-light px-2 py-1 rounded">{{ alert.ip }}</code>
                                </td>
                                <td>
                                    {% if 'sql' in alert.reason.lower() or 'injection' in alert.reason.lower() %}
                                        <span class="badge bg-danger"><i class="bi bi-bug-fill"></i> SQL Injection</span>
                                    {% elif 'brute' in alert.reason.lower() or 'failed password' in alert.reason.lower() %}
                                        <span class="badge bg-danger"><i class="bi bi-key-fill"></i> Brute Force</span>
                                    {% elif 'admin' in alert.reason.lower() or 'probing' in alert.reason.lower() %}
                                        <span class="badge bg-warning"><i class="bi bi-search"></i> Admin Probing</span>
                                    {% elif 'scan' in alert.reason.lower() or 'scanning' in alert.reason.lower() %}
                                        <span class="badge bg-info"><i class="bi bi-radar"></i> Scanning</span>
                                    {% elif 'xss' in alert.reason.lower() or 'script' in alert.reason.lower() %}
                                        <span class="badge bg-danger"><i class="bi bi-code-slash"></i> XSS Attempt</span>
                                    {% elif 'traversal' in alert.reason.lower() %}
                                        <span class="badge bg-danger"><i class="bi bi-folder2-open"></i> Directory Traversal</span>
                                    {% elif 'web' in alert.reason.lower() %}
                                        <span class="badge bg-warning"><i class="bi bi-globe"></i> Web Attack</span>
                                    {% else %}
                                        <span class="badge bg-primary"><i class="bi bi-shield-exclamation"></i> Security Threat</span>
                                    {% endif %}
                                </td>
                                <td class="ai-analysis-cell" data-alert-id="{{ alert.id }}">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status" style="display: none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="ai-content">
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-robot"></i> Loading AI...
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ alert.reason }}</td>
                                <td>
                                    <div class="progress" style="width: 100px; height: 20px;">
                                        {% set confidence_percent = (alert.confidence * 100) | int %}
                                        {% if confidence_percent >= 80 %}
                                            {% set progress_class = 'bg-danger' %}
                                        {% elif confidence_percent >= 60 %}
                                            {% set progress_class = 'bg-warning' %}
                                        {% else %}
                                            {% set progress_class = 'bg-info' %}
                                        {% endif %}
                                        <div class="progress-bar {{ progress_class }}" 
                                             role="progressbar" 
                                             style="width: {{ confidence_percent }}%">
                                            {{ confidence_percent }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">{{ alert.source }}</small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-warning" onclick="recommendBlock('{{ alert.ip }}')">
                                            <i class="bi bi-exclamation"></i> Recommend
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="approveBlock('{{ alert.ip }}')">
                                            <i class="bi bi-ban"></i> Block
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails({{ alert.id }})">
                                            <i class="bi bi-eye"></i> Details
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not alerts %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="bi bi-info-circle"></i> No security alerts found
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // Alert filtering functions
        function filterAlerts() {
            const confidenceFilter = document.getElementById('confidence-filter').value;
            const ipSearch = document.getElementById('ip-search').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const rows = document.querySelectorAll('#alerts-table tbody tr[data-ip]');
            
            rows.forEach(row => {
                let show = true;
                const ip = row.getAttribute('data-ip').toLowerCase();
                const confidence = parseFloat(row.getAttribute('data-confidence'));
                const type = row.getAttribute('data-type');
                
                // Filter by confidence
                if (confidenceFilter === 'high' && confidence < 0.8) show = false;
                if (confidenceFilter === 'medium' && (confidence < 0.6 || confidence >= 0.8)) show = false;
                if (confidenceFilter === 'low' && confidence >= 0.6) show = false;
                
                // Filter by IP
                if (ipSearch && !ip.includes(ipSearch)) show = false;
                
                // Filter by type
                if (typeFilter && !type.includes(typeFilter)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('confidence-filter').value = '';
            document.getElementById('ip-search').value = '';
            document.getElementById('type-filter').value = '';
            filterAlerts();
        }
        
        function applyQuickFilter() {
            const quickFilter = document.getElementById('quick-filter').value;
            const endDate = new Date();
            let startDate = new Date();
            
            const endDateStr = endDate.toISOString().split('T')[0];
            
            switch(quickFilter) {
                case '24h':
                    startDate.setHours(startDate.getHours() - 24);
                    break;
                case '48h':
                    startDate.setHours(startDate.getHours() - 48);
                    break;
                case '7d':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case '30d':
                    startDate.setDate(startDate.getDate() - 30);
                    break;
                case 'all':
                    startDate.setFullYear(2020, 0, 1); // Very old date to get all alerts
                    break;
                default:
                    return; // Custom range - don't update dates
            }
            
            if (quickFilter !== 'custom') {
                const startDateStr = startDate.toISOString().split('T')[0];
                document.getElementById('start-date').value = startDateStr;
                document.getElementById('end-date').value = endDateStr;
                
                // Auto-apply filter for quick selections
                filterAlerts();
            }
        }
        
        function filterAlerts() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalHtml = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
            
            // Make API request to filter alerts
            const url = `/alerts?start_date=${startDate}&end_date=${endDate}`;
            
            // Redirect to filtered URL - simpler than AJAX for now
            window.location.href = url;
        }
        
        async function loadAlertsAjax(startDate, endDate) {
            try {
                const response = await fetch(`/api/alerts?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update summary statistics
                document.querySelector('.col-md-3:nth-child(1) h3').textContent = data.summary.total_alerts;
                document.querySelector('.col-md-3:nth-child(2) h3').textContent = data.summary.critical_alerts;
                document.querySelector('.col-md-3:nth-child(3) h3').textContent = data.summary.medium_alerts;
                document.querySelector('.col-md-3:nth-child(4) h3').textContent = data.summary.unique_ips;
                
                // Update alerts table
                updateAlertsTable(data.alerts);
                
                // Update date range info
                const startDateObj = new Date(data.summary.start_date);
                const endDateObj = new Date(data.summary.end_date);
                const rangeInfo = document.querySelector('.text-muted small');
                if (rangeInfo) {
                    rangeInfo.innerHTML = `<i class="bi bi-info-circle"></i> Showing alerts from ${startDateObj.toLocaleDateString()} to ${endDateObj.toLocaleDateString()}`;
                }
                
            } catch (error) {
                console.error('Error loading alerts:', error);
                alert('Error loading alerts: ' + error.message);
            }
        }
        
        function updateAlertsTable(alerts) {
            const tbody = document.querySelector('#alerts-table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            alerts.forEach(alert => {
                const confidence = (alert.confidence * 100).toFixed(1);
                const confidenceClass = alert.confidence >= 0.8 ? 'danger' : (alert.confidence >= 0.6 ? 'warning' : 'info');
                const alertDate = new Date(alert.created_at).toLocaleString();
                
                const row = `
                    <tr data-ip="${alert.ip}" data-confidence="${alert.confidence}" data-type="${alert.reason}">
                        <td><code class="text-${confidenceClass}">${alert.ip}</code></td>
                        <td>${alert.reason}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-${confidenceClass}" 
                                     style="width: ${confidence}%">
                                    ${confidence}%
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-secondary">${alert.source}</span></td>
                        <td><small>${alertDate}</small></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-danger" onclick="blockIPFromAlert('${alert.ip}', '${alert.reason}')">
                                    <i class="bi bi-ban"></i> Block
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails(${alert.id})">
                                    <i class="bi bi-eye"></i> Details
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function refreshAlerts() {
            location.reload();
        }
        
        function viewDetails(alertId) {
            // Show alert details in a modal or redirect
            alert('Alert details functionality - to be implemented');
        }
        
        function blockIPFromAlert(ip, reason) {
            if (confirm(`Block IP ${ip}?`)) {
                fetch('/api/firewall/blacklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip: ip, reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`IP ${ip} has been blocked successfully`);
                        // Optionally refresh alerts or update UI
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Network error occurred');
                });
            }
        }
        
        // Load AI analysis for each alert
        async function loadAIAnalysis(alertId) {
            const cell = document.querySelector(`.ai-analysis-cell[data-alert-id="${alertId}"]`);
            if (!cell) return;
            
            const spinner = cell.querySelector('.spinner-border');
            const content = cell.querySelector('.ai-content');
            
            try {
                spinner.style.display = 'inline-block';
                
                const response = await fetch(`/api/ai/analyze/${alertId}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.analysis) {
                    const analysis = data.analysis;
                    const severityColor = getSeverityColor(analysis.severity_level);
                    const riskScore = analysis.risk_score || 50;
                    
                    content.innerHTML = `
                        <div class="d-flex flex-column">
                            <div class="mb-1">
                                <span class="badge ${severityColor}">
                                    <i class="bi bi-robot"></i> ${analysis.severity_level || 'MEDIUM'}
                                </span>
                                <span class="badge bg-light text-dark ms-1">
                                    Risk: ${riskScore}/100
                                </span>
                            </div>
                            <small class="text-muted">
                                ${analysis.threat_category || 'Security Threat'}
                            </small>
                            <small class="text-truncate" title="${analysis.explanation || 'AI analysis completed'}">
                                ${(analysis.explanation || 'AI analysis completed').substring(0, 60)}...
                            </small>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-exclamation-triangle"></i> AI Error</span>';
                }
            } catch (error) {
                console.error('AI analysis error:', error);
                content.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> AI Unavailable</span>';
            } finally {
                spinner.style.display = 'none';
            }
        }
        
        function getSeverityColor(severity) {
            switch(severity) {
                case 'CRITICAL': return 'bg-danger';
                case 'HIGH': return 'bg-warning';
                case 'MEDIUM': return 'bg-info';
                case 'LOW': return 'bg-success';
                default: return 'bg-secondary';
            }
        }
        
        // Enhanced viewDetails with AI analysis modal
        function viewDetails(alertId) {
            showAIAnalysisModal(alertId);
        }
        
        async function showAIAnalysisModal(alertId) {
            try {
                const response = await fetch(`/api/ai/analyze/${alertId}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.analysis) {
                    const analysis = data.analysis;
                    
                    const modalContent = `
                        <div class="modal fade" id="aiAnalysisModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="bi bi-robot"></i> AI Security Analysis
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <h6>Threat Level</h6>
                                                <span class="badge ${getSeverityColor(analysis.severity_level)} fs-6">
                                                    ${analysis.severity_level || 'UNKNOWN'}
                                                </span>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Risk Score</h6>
                                                <div class="progress">
                                                    <div class="progress-bar bg-danger" style="width: ${analysis.risk_score || 50}%">
                                                        ${analysis.risk_score || 50}/100
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Threat Category</h6>
                                            <p class="text-primary">${analysis.threat_category || 'Security Threat'}</p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Explanation</h6>
                                            <p>${analysis.explanation || 'No detailed explanation available.'}</p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Attack Vector</h6>
                                            <p>${analysis.attack_vector || 'Network-based attack attempt'}</p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Potential Impact</h6>
                                            <p>${analysis.potential_impact || 'Potential system compromise if successful'}</p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Recommended Actions</h6>
                                            <ul class="list-unstyled">
                                                ${(analysis.recommended_actions || ['Monitor activity', 'Review logs']).map(action => `<li><i class="bi bi-check-circle text-success"></i> ${action}</li>`).join('')}
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Technical Details</h6>
                                            <small class="text-muted">${analysis.technical_details || 'No additional technical details available.'}</small>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-danger" onclick="blockThreat('${data.alert_id}')">
                                            <i class="bi bi-shield-x"></i> Block Threat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal
                    const existingModal = document.getElementById('aiAnalysisModal');
                    if (existingModal) existingModal.remove();
                    
                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
                    modal.show();
                } else {
                    alert('AI analysis not available for this alert');
                }
            } catch (error) {
                console.error('Error loading AI analysis:', error);
                alert('Failed to load AI analysis');
            }
        }
        
        function blockThreat(alertId) {
            // Find the alert row to get IP
            const row = document.querySelector(`tr[data-alert-id="${alertId}"]`);
            if (row) {
                const ip = row.dataset.ip;
                blockIPFromAlert(ip, 'Blocked via AI recommendation');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiAnalysisModal'));
                if (modal) modal.hide();
            }
        }
        
        // Initialize with 48-hour default on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set the quick filter to show current selection
            const quickFilter = document.getElementById('quick-filter');
            {% if date_range and date_range.is_default_range %}
            quickFilter.value = '48h';
            {% else %}
            quickFilter.value = 'custom';
            {% endif %}
            
            // Load AI analysis for all visible alerts
            const alertRows = document.querySelectorAll('tr[data-alert-id]');
            alertRows.forEach(row => {
                const alertId = row.dataset.alertId;
                if (alertId) {
                    // Delay loading to spread out API calls
                    setTimeout(() => loadAIAnalysis(alertId), Math.random() * 2000);
                }
            });
        });
    </script>
</body>
</html>