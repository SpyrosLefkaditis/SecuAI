<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuAI - Security Monitoring Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- Plotly.js for System Monitoring Charts -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-check"></i> SecuAI
                <span class="badge bg-success ms-2">MVP</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav me-auto">
                    <a class="nav-link active" href="/">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="/alerts">
                        <i class="bi bi-exclamation-triangle"></i> Alerts
                    </a>
                    <a class="nav-link" href="/firewall">
                        <i class="bi bi-shield-lock"></i> Firewall
                    </a>
                    <a class="nav-link" href="/analysis">
                        <i class="bi bi-search"></i> Analysis
                    </a>
                </div>
                
                <div class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <span class="navbar-text me-3">
                        <i class="bi bi-person-circle"></i> {{ current_user.username }}
                    </span>
                    <a class="nav-link" href="/admin">
                        <i class="bi bi-gear"></i> Admin
                    </a>
                    <a class="nav-link" href="/logout">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title">{{ stats.alerts_today }}</h4>
                                <p class="card-text">Alerts Today</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-exclamation-triangle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title">{{ stats.critical_alerts }}</h4>
                                <p class="card-text">Critical Alerts</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-exclamation-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title">{{ stats.blocked_ips }}</h4>
                                <p class="card-text">Blocked IPs</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-ban fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="system-status">Online</h4>
                                <p class="card-text">System Status</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-shield-check fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: System Monitoring -->
            <div class="col-lg-8">
                <!-- System Performance Dashboard -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-speedometer2"></i> System Performance
                        </h5>
                        <div>
                            <span class="badge bg-success" id="monitoring-status">Live</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshSystemStats()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Real-time System Charts -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header bg-dark text-white">
                                        <h6 class="mb-0"><i class="bi bi-cpu"></i> CPU Usage</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="cpu-chart" style="height: 200px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header bg-dark text-white">
                                        <h6 class="mb-0"><i class="bi bi-memory"></i> Memory Usage</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="memory-chart" style="height: 200px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header bg-dark text-white">
                                        <h6 class="mb-0"><i class="bi bi-hdd"></i> Disk Usage</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="disk-chart" style="height: 200px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header bg-dark text-white">
                                        <h6 class="mb-0"><i class="bi bi-activity"></i> Load Average</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="load-chart" style="height: 200px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Stats Summary -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success" id="uptime-display">--</h4>
                                    <small class="text-muted">System Uptime</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info" id="processes-count">--</h4>
                                    <small class="text-muted">Running Processes</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning" id="failed-services">--</h4>
                                    <small class="text-muted">Failed Services</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary" id="network-connections">--</h4>
                                    <small class="text-muted">Network Connections</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Processes -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-task"></i> Top 10 Processes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>PID</th>
                                        <th>Process</th>
                                        <th>CPU %</th>
                                        <th>Memory %</th>
                                        <th>User</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="processes-table">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="bi bi-hourglass-split"></i> Loading processes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- System Overview -->
                <div class="card" id="system-overview">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-activity"></i> System Overview
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshOverview()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-cpu"></i> System Status</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success"></i> Firewall Active</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Log Analysis Running</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Database Connected</li>
                                    <li><i class="bi bi-info-circle text-info"></i> Simulation Mode Enabled</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-shield-check"></i> Security Status</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-ban text-danger"></i> {{ stats.blocked_ips }} IPs Blocked</li>
                                    <li><i class="bi bi-exclamation-triangle text-warning"></i> {{ stats.alerts_today }} Alerts Today</li>
                                    <li><i class="bi bi-shield-plus text-success"></i> Whitelist Active</li>
                                    <li><i class="bi bi-graph-up text-info"></i> System Monitoring</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-4">
                                    <a href="/firewall" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-shield-lock"></i><br>
                                        <small>Firewall</small>
                                    </a>
                                </div>
                                <div class="col-4">
                                    <a href="/alerts" class="btn btn-outline-warning w-100">
                                        <i class="bi bi-exclamation-triangle"></i><br>
                                        <small>View Alerts</small>
                                    </a>
                                </div>
                                <div class="col-4">
                                    <a href="/analysis" class="btn btn-outline-info w-100">
                                        <i class="bi bi-search"></i><br>
                                        <small>Analyze Logs</small>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Honeypot -->
            <div class="col-lg-4">
                <!-- Honeypot Feed -->
                <div class="card" id="honeypot">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bug"></i> Honeypot Feed
                        </h5>
                        <button class="btn btn-sm btn-outline-success" onclick="loadHoneypotFeed()">
                            <i class="bi bi-download"></i> Load Feed
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="honeypot-status" class="mb-3">
                            <span class="badge bg-success">Active</span>
                            <small class="text-muted ms-2">Monitoring threats...</small>
                        </div>
                        
                        <div id="honeypot-data">
                            <div class="text-center text-muted">
                                <i class="bi bi-cloud-download"></i><br>
                                Click "Load Feed" to fetch latest threat intelligence
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Footer -->
    <footer class="mt-5 py-4 bg-dark text-light">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>SecuAI</h5>
                    <p class="text-muted">Log & Network Anomaly Detection System</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted">
                        <i class="bi bi-shield-check"></i> Hackathon MVP Version<br>
                        <small>⚠️ For testing purposes only</small>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="bi bi-moon-fill" id="theme-icon"></i>
    </button>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // System monitoring variables
        let systemMonitoringInterval;
        let cpuChart, memoryChart, diskChart, loadChart;
        
        // Initialize system monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystemCharts();
            loadSystemStats();
            loadTopProcesses();
            
            // Start auto-refresh every 5 seconds
            systemMonitoringInterval = setInterval(() => {
                loadSystemStats();
                loadTopProcesses();
            }, 5000);
        });
        
        function initializeSystemCharts() {
            // Dark theme layout for all charts
            const darkLayout = {
                paper_bgcolor: '#0a0a0a',
                plot_bgcolor: '#000000',
                font: { color: '#ffffff', size: 12 },
                margin: { l: 40, r: 20, t: 30, b: 40 },
                showlegend: false
            };
            
            // CPU Chart
            const cpuData = [{
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'CPU %',
                line: { color: '#22c55e', width: 3 },
                marker: { color: '#22c55e', size: 6 }
            }];
            
            cpuChart = Plotly.newPlot('cpu-chart', cpuData, {
                ...darkLayout,
                title: { text: 'CPU Usage %', font: { color: '#ffffff' } },
                yaxis: { range: [0, 100], gridcolor: '#333333' },
                xaxis: { type: 'date', gridcolor: '#333333' }
            }, { responsive: true });
            
            // Memory Chart
            const memoryData = [{
                values: [0, 100],
                labels: ['Used', 'Free'],
                type: 'pie',
                hole: 0.6,
                marker: {
                    colors: ['#ef4444', '#374151']
                },
                textinfo: 'none',
                hovertemplate: '%{label}: %{value}%<extra></extra>'
            }];
            
            memoryChart = Plotly.newPlot('memory-chart', memoryData, {
                ...darkLayout,
                title: { text: 'Memory Usage', font: { color: '#ffffff' } }
            }, { responsive: true });
            
            // Disk Chart
            const diskData = [{
                values: [0, 100],
                labels: ['Used', 'Free'],
                type: 'pie',
                hole: 0.6,
                marker: {
                    colors: ['#f59e0b', '#374151']
                },
                textinfo: 'none',
                hovertemplate: '%{label}: %{value}%<extra></extra>'
            }];
            
            diskChart = Plotly.newPlot('disk-chart', diskData, {
                ...darkLayout,
                title: { text: 'Disk Usage', font: { color: '#ffffff' } }
            }, { responsive: true });
            
            // Load Average Chart
            const loadData = [{
                x: ['1 min', '5 min', '15 min'],
                y: [0, 0, 0],
                type: 'bar',
                marker: { color: '#3b82f6' }
            }];
            
            loadChart = Plotly.newPlot('load-chart', loadData, {
                ...darkLayout,
                title: { text: 'Load Average', font: { color: '#ffffff' } },
                yaxis: { gridcolor: '#333333' },
                xaxis: { gridcolor: '#333333' }
            }, { responsive: true });
        }
        
        async function loadSystemStats() {
            try {
                const response = await fetch('/api/system/stats');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update system stats summary
                document.getElementById('uptime-display').textContent = data.uptime;
                document.getElementById('processes-count').textContent = data.processes_count;
                document.getElementById('failed-services').textContent = data.failed_services;
                document.getElementById('network-connections').textContent = data.network_connections;
                
                // Update CPU chart
                const cpuTime = new Date();
                Plotly.extendTraces('cpu-chart', {
                    x: [[cpuTime]],
                    y: [[data.cpu.percent]]
                }, [0]);
                
                // Keep only last 20 points
                if (cpuChart.data[0].x.length > 20) {
                    Plotly.relayout('cpu-chart', {
                        'xaxis.range': [cpuChart.data[0].x[cpuChart.data[0].x.length - 20], cpuTime]
                    });
                }
                
                // Update Memory chart
                const memoryUsed = data.memory.percent;
                const memoryFree = 100 - memoryUsed;
                Plotly.restyle('memory-chart', {
                    values: [[memoryUsed, memoryFree]],
                    'title.text': `Memory: ${data.memory.used_gb}GB / ${data.memory.total_gb}GB (${memoryUsed}%)`
                });
                
                // Update Disk chart
                const diskUsed = data.disk.percent;
                const diskFree = 100 - diskUsed;
                Plotly.restyle('disk-chart', {
                    values: [[diskUsed, diskFree]],
                    'title.text': `Disk: ${data.disk.used_gb}GB / ${data.disk.total_gb}GB (${diskUsed.toFixed(1)}%)`
                });
                
                // Update Load Average chart
                Plotly.restyle('load-chart', {
                    y: [data.load_avg]
                });
                
                // Update monitoring status
                document.getElementById('monitoring-status').textContent = 'Live';
                document.getElementById('monitoring-status').className = 'badge bg-success';
                
            } catch (error) {
                console.error('Error loading system stats:', error);
                document.getElementById('monitoring-status').textContent = 'Error';
                document.getElementById('monitoring-status').className = 'badge bg-danger';
            }
        }
        
        async function loadTopProcesses() {
            try {
                const response = await fetch('/api/system/processes');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const tbody = document.getElementById('processes-table');
                tbody.innerHTML = '';
                
                data.processes.forEach(proc => {
                    const statusColor = proc.status === 'running' ? 'success' : 
                                       proc.status === 'sleeping' ? 'info' : 'warning';
                    
                    const row = `
                        <tr>
                            <td><code>${proc.pid}</code></td>
                            <td><strong>${proc.name}</strong></td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-primary" style="width: ${Math.min(proc.cpu_percent, 100)}%">
                                        ${proc.cpu_percent}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-warning" style="width: ${Math.min(proc.memory_percent, 100)}%">
                                        ${proc.memory_percent}%
                                    </div>
                                </div>
                            </td>
                            <td><small>${proc.username}</small></td>
                            <td><span class="badge bg-${statusColor}">${proc.status}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading processes:', error);
                document.getElementById('processes-table').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error loading processes
                        </td>
                    </tr>
                `;
            }
        }
        
        function refreshSystemStats() {
            loadSystemStats();
            loadTopProcesses();
        }
        
        function refreshOverview() {
            location.reload();
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (systemMonitoringInterval) {
                clearInterval(systemMonitoringInterval);
            }
        });
    </script>
</body>
</html>